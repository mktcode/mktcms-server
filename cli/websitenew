#!/usr/bin/env bash
set -euo pipefail

DOMAIN_NAME=$1
APP_PORT=$2
RANDOM_AUTH_KEY=$(openssl rand -base64 32 | tr -d /=+ | cut -c1-32)

# Exit if website dir or config files already exists
if [[ -f "/etc/nginx/sites-available/${DOMAIN_NAME}.conf" || -f "/etc/supervisor/conf.d/${DOMAIN_NAME}.conf" || -d "/var/www/websites/${DOMAIN_NAME}" ]]; then
    echo "Error: Website configuration or directory for ${DOMAIN_NAME} already exists." >&2
    exit 1
fi

# Search supervisor configs for PORT=${APP_PORT} to avoid port conflicts
if grep -q "PORT=\"${APP_PORT}\"" /etc/supervisor/conf.d/*.conf; then
    echo "Error: Port ${APP_PORT} is already in use by another application." >&2
    exit 1
fi

# Resolve templates relative to this script, not the current working directory.
SCRIPT_DIR="$(cd -P -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" && pwd)"
TEMPLATE_DIR="$SCRIPT_DIR/../website"

if [[ ! -f "$TEMPLATE_DIR/nginx.conf" || ! -f "$TEMPLATE_DIR/supervisor.conf" ]]; then
	echo "Template files not found in $TEMPLATE_DIR" >&2
	exit 1
fi

# Nginx Config
sed "s/{{DOMAIN_NAME}}/${DOMAIN_NAME}/g; s/{{APP_PORT}}/${APP_PORT}/g" "$TEMPLATE_DIR/nginx.conf" > "/etc/nginx/sites-available/${DOMAIN_NAME}.conf"
ln -s "/etc/nginx/sites-available/${DOMAIN_NAME}.conf" "/etc/nginx/sites-enabled/${DOMAIN_NAME}.conf"

# Supervisor Config
sed "s/{{DOMAIN_NAME}}/${DOMAIN_NAME}/g; s/{{APP_PORT}}/${APP_PORT}/g; s/{{RANDOM_AUTH_KEY}}/${RANDOM_AUTH_KEY}/g" "$TEMPLATE_DIR/supervisor.conf" > "/etc/supervisor/conf.d/${DOMAIN_NAME}.conf"

# Clone Repo and setup
mkdir /var/www/websites/${DOMAIN_NAME}
cd /var/www/websites/${DOMAIN_NAME}
git clone git@github.com:mktcode/${DOMAIN_NAME}.git .

# Initialize Content
cp -r content .storage

### Check for better way (use websites user to clone/pull)
git config --global --add safe.directory /var/www/websites/${DOMAIN_NAME}
###

npm ci
npm run build
chown -R websites:websites /var/www/websites/${DOMAIN_NAME}

# Reload Services
nginx -t
systemctl reload nginx
supervisorctl reread
supervisorctl update

echo "Website ${DOMAIN_NAME} has been created."
echo "Auth Key: ${RANDOM_AUTH_KEY}"
echo "Please run the certificate setup script to enable HTTPS:"
echo "websitecert ${DOMAIN_NAME} <email_address>"